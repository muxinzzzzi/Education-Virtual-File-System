# 结构化审稿系统测试指南

## ✅ 已实现功能

### 1. 服务器端
- ✅ 结构化审稿数据结构（JSON格式）
- ✅ 保存/读取审稿意见（JSON文件）
- ✅ 草稿保存功能（SAVE_REVIEW_DRAFT）
- ✅ 草稿读取功能（GET_REVIEW_DRAFT）
- ✅ 提交最终审稿（SUBMIT_REVIEW）
- ✅ 编辑查看结构化审稿意见（handle_view_review_progress）
- ✅ 决定更新BUG修复（数字映射）

### 2. 客户端
- ✅ 表单式审稿输入界面
- ✅ 多行文本输入支持
- ✅ 自动加载已保存的草稿
- ✅ 草稿保存/提交选择
- ✅ 编辑查看结构化审稿意见展示

## 🧪 完整测试流程

### 前置准备

```bash
cd /Users/muxin/Desktop/Education-Virtual-File-System/build

# 1. 清理旧数据（重要！旧.txt格式不兼容）
killall review_server 2>/dev/null
rm -f review_system.img review_system.img.*

# 2. 启动服务器（前台运行以查看日志）
./src/server/review_server
```

### 测试场景1：审稿人完整审稿流程

**终端1 - 作者alice上传论文**
```bash
./src/client/review_client 127.0.0.1 8080
```
操作：
1. 登录：`alice / password123`
2. 选择 `[1] 上传新论文`
3. 标题：`Test Structured Review`
4. 文件路径：`/Users/muxin/Desktop/Education-Virtual-File-System/nips1.pdf`
5. 盲审策略：`single`
6. 研究领域：`ai,nlp`
7. 关键词：`transformer,attention`
8. 冲突审稿人：（留空）

**终端2 - 编辑charlie分配审稿人**
```bash
./src/client/review_client 127.0.0.1 8080
```
操作：
1. 登录：`charlie / password123` (editor)
2. 选择 `[6] 自动分配审稿人`
3. 论文ID：`P1`
4. 分配审稿人数量：`1`
5. 确认：`y`

**终端3 - 审稿人bob审稿（重点测试）**
```bash
./src/client/review_client 127.0.0.1 8080
```

#### 步骤1：保存草稿
1. 登录：`bob / password123` (reviewer)
2. 选择 `[1] 提交审稿意见`
3. 论文ID：`P1`
4. （系统提示：没有已保存的草稿）
5. 输入总评（多行）：
   ```
   这是一个有趣的工作，但还需要改进。
   主要贡献在于提出了新的注意力机制。
   （输入空行结束）
   ```
6. 输入优点：
   ```
   1. 方法创新性强
   2. 实验设计合理
   （输入空行结束）
   ```
7. 输入缺点：
   ```
   1. 写作需要润色
   2. 对比实验不够充分
   （输入空行结束）
   ```
8. 输入问题/建议：
   ```
   建议增加消融实验
   （输入空行结束）
   ```
9. 评分：`4` (Weak Accept)
10. 置信度：`4` (High)
11. **选择操作：`1`** （💾 保存草稿）
12. ✅ 看到"草稿已保存"

#### 步骤2：重新进入，继续编辑草稿
1. 退出登录（选择 `[6]`）
2. 重新登录：`bob / password123`
3. 选择 `[1] 提交审稿意见`
4. 论文ID：`P1`
5. ✅ **看到提示："找到已保存的草稿！"**
6. ✅ **看到草稿预览（总评前50字+评分）**
7. 选择使用草稿：`y`
8. 各字段显示 `[已有内容，按回车保留或重新输入]`
9. 按回车保留所有字段（或修改某些字段）
10. 这次**选择操作：`2`** （✅ 提交审稿意见）
11. ✅ 看到"审稿意见已提交"

### 测试场景2：编辑查看结构化审稿意见

**终端2 - 编辑charlie查看审稿进度**
继续在charlie的会话中：
1. 选择 `[4] 查看审稿进度`
2. 论文ID：`P1`
3. ✅ **看到结构化审稿意见展示：**
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     📊 论文 P1 的审稿意见汇总
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [审稿人 1] bob
   评分: 4 - Weak Accept | 置信度: 4/5
   状态: ✓ 已提交
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   【总评】
   这是一个有趣的工作，但还需要改进。
   主要贡献在于提出了新的注意力机制。
   
   【优点】
   1. 方法创新性强
   2. 实验设计合理
   
   【缺点】
   1. 写作需要润色
   2. 对比实验不够充分
   
   【问题/建议】
   建议增加消融实验
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
     共 1 条审稿意见
   ```

### 测试场景3：编辑做出决定（验证BUG修复）

继续在charlie的会话中：
1. 选择 `[2] 做出最终决定`
2. 论文ID：`P1`
3. 选择决定：`1` (accept)
4. 确认：`y`
5. ✅ 看到"Decision updated"

**服务器端应输出：**
```
[DEBUG] Making decision for P1, decision=1, state before=...
[DEBUG] State after decision=ACCEPTED
[DEBUG] Decision saved successfully
```

6. 选择 `[3] 查看待处理论文`
7. ✅ **P1不应该出现在列表中**（因为已ACCEPTED，不再pending）

### 测试场景4：作者查看论文状态

**终端1 - 回到alice会话**
1. 选择 `[2] 查看论文状态`
2. 输入 `0` 查看列表
3. ✅ **看到P1显示为"Accepted ✓"**

## 📋 预期结果检查清单

### 草稿功能
- [ ] 初次审稿时提示"没有已保存的草稿"
- [ ] 保存草稿后提示"草稿已保存"
- [ ] 重新进入能加载草稿，显示预览
- [ ] 草稿内容可以保留或重新输入
- [ ] 草稿可以被最终提交覆盖

### 表单输入
- [ ] 多行文本输入正常（以空行结束）
- [ ] 输入 `/cancel` 可以取消
- [ ] 总评和评分为必填项
- [ ] 评分必须是1-5
- [ ] 置信度必须是1-5
- [ ] 可以选择保存草稿或提交

### 审稿意见展示
- [ ] 编辑能看到结构化的审稿意见
- [ ] 显示审稿人姓名
- [ ] 显示评分（1-5的描述性文本）
- [ ] 显示置信度
- [ ] 显示状态（已提交/草稿）
- [ ] 分段显示总评、优点、缺点、问题

### 决定更新
- [ ] 编辑输入数字1能正确映射为accept
- [ ] 决定保存成功
- [ ] 论文状态更新为ACCEPTED
- [ ] 待处理列表中不再显示已决定的论文
- [ ] 作者能看到决定结果

## 🐛 可能的问题

### 问题1：审稿意见列表为空
**原因**：可能存在旧的.txt格式审稿文件
**解决**：删除review_system.img重新开始

### 问题2：草稿加载失败
**原因**：JSON解析错误
**检查**：服务器日志是否有错误信息

### 问题3：决定没有更新
**原因**：可能用了旧的服务器进程
**解决**：`killall review_server` 然后重启

## 📁 文件位置

### 服务器端
- 审稿意见存储：`/papers/P1/rounds/R1/reviews/bob.json`
- 审稿数据结构：`include/server/review_data.h`
- 服务器逻辑：`src/server/review_server.cpp`

### 客户端
- 表单输入实现：`src/client/review_client.cpp::submit_review()`
- 审稿意见展示：编辑会话的"查看审稿进度"

## 🎉 测试成功标志

如果以上所有步骤都能正常执行，你应该能看到：
1. ✅ 审稿人能保存草稿、加载草稿、继续编辑、最终提交
2. ✅ 编辑能看到结构化的、格式化的审稿意见
3. ✅ 编辑输入数字1能正确做出accept决定
4. ✅ 论文状态正确更新为ACCEPTED
5. ✅ 作者能看到论文被接收

**恭喜！结构化审稿系统已完全实现并测试通过！** 🎊

